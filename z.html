<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×”×–×× ×•×ª ×—.×¡×‘×Ÿ - ×™×•×§×¨×ª×™</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- SweetAlert2 for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Google Fonts - Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Rubik:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* General Body and Font */
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl; /* Right-to-left for Hebrew */
            text-align: right; /* Align text to the right */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: linear-gradient(to bottom, #000000 0%, #000000 20%, #e0f2fe 20%, #e0f2fe 100%); /* Original background */
            transition: background-color 0.3s ease; /* Smooth transition for dark mode */
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(to bottom, #1a202c 0%, #1a202c 20%, #2d3748 20%, #2d3748 100%);
            color: #e2e8f0;
        }

        .app-container.dark-mode {
            background-color: #2d3748;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            border-color: #4a5568;
        }

        .app-container.dark-mode h1,
        .app-container.dark-mode h2,
        .app-container.dark-mode h3,
        .app-container.dark-mode h4 {
            color: #e2e8f0;
        }

        .app-container.dark-mode p,
        .app-container.dark-mode label {
            color: #cbd5e0;
        }

        .app-container.dark-mode .form-control,
        .app-container.dark-mode .form-control-file {
            background-color: rgba(255, 255, 255, 0.1); /* Lighter glass effect */
            border-color: rgba(255, 255, 255, 0.2);
            color: #e2e8f0;
        }

        .app-container.dark-mode .form-control:focus,
        .app-container.dark-mode .form-control-file:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 110, 234, 0.4);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .app-container.dark-mode .form-control::placeholder {
            color: #a0aec0;
        }

        .app-container.dark-mode .bg-gray-50 {
            background-color: #4a5568;
            border-color: #667eea;
        }

        .app-container.dark-mode .bg-blue-50 {
            background-color: #4a5568;
            border-color: #4299e1;
        }

        .app-container.dark-mode .bg-green-50 {
            background-color: #4a5568;
            border-color: #48bb78;
        }

        .app-container.dark-mode .bg-yellow-50 {
            background-color: #4a5568;
            border-color: #f6e05e;
        }

        .app-container.dark-mode .bg-purple-50 {
            background-color: #4a5568;
            border-color: #9f7aea;
        }

        .app-container.dark-mode .product-selection {
            background-color: #4a5568;
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .app-container.dark-mode .product-selection:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .app-container.dark-mode .product-info-display {
            background-color: #4299e1;
            border-left-color: #3182ce;
        }

        .app-container.dark-mode .product-history-info {
            background-color: #f6ad55;
            border-left-color: #ed8936;
        }

        .app-container.dark-mode .current-order-product-item {
            background-color: #4a5568;
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .app-container.dark-mode .current-order-product-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .app-container.dark-mode .chat-messages {
            background-color: #4a5568;
            border-color: #667eea;
        }

        .app-container.dark-mode .chat-message.user-message {
            background-color: #4299e1;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .app-container.dark-mode .chat-message.admin-message {
            background-color: #48bb78;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .app-container.dark-mode .modal-content {
            background-color: #2d3748;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .app-container.dark-mode .modal-title,
        .app-container.dark-mode .receipt-content h4,
        .app-container.dark-mode .receipt-content p strong,
        .app-container.dark-mode .product-receipt-name {
            color: #e2e8f0;
        }

        .app-container.dark-mode .receipt-content {
            background-color: #4a5568;
            border-color: #667eea;
        }

        .app-container.dark-mode .nav-button {
            color: #a0aec0;
        }

        .app-container.dark-mode .nav-button.active {
            color: #9f7aea;
            background-color: #4a5568;
            box-shadow: 0 2px 5px rgba(159, 122, 234, 0.3);
        }

        .app-container.dark-mode .nav-button:hover:not(.active) {
            color: #cbd5e0;
            background-color: #4a5568;
        }

        .bottom-nav-bar.dark-mode {
            background-color: #2d3748;
            border-top-color: #4a5568;
            box-shadow: 0 -10px 20px rgba(0, 0, 0, 0.5);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Dark Mode Scrollbar */
        body.dark-mode .custom-scrollbar::-webkit-scrollbar-track {
            background: #4a5568;
        }

        body.dark-mode .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a0aec0;
        }

        body.dark-mode .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }

        /* App Container */
        .app-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2.5rem; /* Increased padding */
            max-width: 56rem; /* Increased max-width for more space */
            width: 100%;
            height: calc(100vh - 2rem); /* Adjusted for full height minus padding */
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden; /* Ensure content stays within bounds */
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        /* Header */
        header {
            margin-bottom: 2rem;
        }

        h1, h2, h3, h4 {
            font-family: 'Rubik', sans-serif; /* Use Rubik for headings */
        }

        h1 {
            color: #1a202c; /* Darker blue for headings */
        }

        h2 {
            color: #6b46c1; /* Purple for typing effect */
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 0.625rem;
            margin-top: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: linear-gradient(to right, #4299e1, #805ad5);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }

        .progress-step-label {
            flex: 1;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 500;
            color: #718096;
        }

        .progress-step-label.active-step {
            color: #2d3748; /* Darker text for active step */
            font-weight: 600;
        }

        body.dark-mode .progress-bar-container {
            background-color: #4a5568;
        }

        body.dark-mode .progress-step-label {
            color: #a0aec0;
        }

        body.dark-mode .progress-step-label.active-step {
            color: #e2e8f0;
        }

        /* Glassmorphism Input Fields */
        .glass-input {
            background: rgba(255, 255, 255, 0.15); /* Semi-transparent white */
            backdrop-filter: blur(10px); /* Blur effect */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: #2d3748; /* Dark text */
            transition: all 0.3s ease;
            padding: 0.8rem 1rem;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            width: 100%;
        }

        .glass-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 3px rgba(102, 110, 234, 0.25);
            background: rgba(255, 255, 255, 0.25);
        }

        .glass-input::placeholder {
            color: #718096;
        }

        /* Shine/Glow Button Effect */
        .btn-shine {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-shine::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(60deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 70%);
            transform: rotate(45deg);
            transition: all 0.7s ease-in-out;
            opacity: 0;
            z-index: -1;
        }

        .btn-shine:hover::before {
            left: -20%;
            opacity: 1;
        }

        .btn-shine:active {
            transform: scale(0.98);
            transition: transform 0.1s ease-out;
        }

        /* Loading Spinner for Buttons */
        .btn-loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5em;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Typing Effect Cursor */
        .typing-effect {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: #6b46c1;
            vertical-align: middle;
            animation: blink-caret 0.75s step-end infinite;
        }

        @keyframes blink-caret {
            from, to { background-color: transparent; }
            50% { background-color: #6b46c1; }
        }

        /* Animation for pulse effect on confirmation message */
        .animate-pulse-effect {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.03); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Responsive Adjustments (from original, enhanced with Tailwind classes) */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .app-container {
                padding: 1rem;
                max-width: 100%;
                height: calc(100vh - 4rem);
                border-radius: 1rem;
            }

            .btn-primary, .btn-secondary {
                padding: 0.7rem 1.2rem;
                font-size: 1rem;
            }

            .modal-content {
                padding: 1rem;
                border-radius: 1rem;
            }

            .modal-title {
                font-size: 1.5rem;
            }

            .bottom-nav-bar {
                padding: 0.5rem;
            }

            .nav-button {
                padding: 0.5rem;
            }

            .nav-button i {
                font-size: 1.5rem;
            }

            .nav-button span {
                font-size: 0.7rem;
            }

            .product-selection {
                padding: 1rem;
                border-radius: 0.75rem;
            }

            .product-info-display {
                flex-direction: column;
                align-items: flex-start;
            }

            .product-image-thumb {
                width: 40px;
                height: 40px;
            }

            .current-order-product-item {
                flex-wrap: wrap;
                justify-content: space-between;
                padding: 0.5rem;
            }

            .product-details-summary {
                flex-basis: 60%;
            }

            .product-quantity-controls {
                flex-basis: 30%;
                justify-content: flex-end;
            }

            .action-buttons {
                flex-basis: 100%;
                margin-top: 0.5rem;
                text-align: center;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col items-center justify-between p-4 font-sans text-right">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-[10000] text-white transition-opacity duration-300 opacity-0 invisible">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16 mb-4"></div>
        <p class="text-xl font-semibold">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
    </div>

    <div class="app-container bg-white rounded-3xl shadow-2xl p-8 w-full max-w-4xl border border-blue-200 transform transition-all duration-500 scale-95 hover:scale-100 flex flex-col">
        <header class="text-center mb-8">
            <!-- Dark Mode Toggle -->
            <div class="absolute top-4 left-4">
                <button id="darkModeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 shadow-md transition-colors duration-300">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline-block"></i>
                </button>
            </div>
            <!-- Logos for collaboration -->
            <div class="flex items-center justify-center mb-4 gap-4">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTcYS_xImwWt1fAYIK1UTXHtbCfmt5TOny5UQ&s" alt="×œ×•×’×• ×–×‘×•×œ×•×Ÿ ×¢×“×™×¨×Ÿ" class="h-16 w-auto rounded-full shadow-md border border-gray-200">
                <span class="text-3xl font-bold text-gray-700 dark:text-gray-300">|</span>
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRR1_PVzqyK74L9l5eC5grCsPGCsTinQnmHvw&s" alt="×œ×•×’×• ×—. ×¡×‘×Ÿ" class="h-16 w-auto rounded-full shadow-md border border-gray-200">
            </div>
            <h1 class="text-4xl font-extrabold text-dark-blue mb-2 dark:text-white">××¢×¨×›×ª ×”×–×× ×•×ª <span class="text-orange-500">×¡×‘×Ÿ</span></h1>
            <p class="text-lg text-gray-700 mb-4 dark:text-gray-300">
                <span id="currentDateTime" class="font-medium"></span>
            </p>
            <h2 id="typingEffectText" class="text-2xl font-semibold text-purple-700 min-h-[32px] dark:text-purple-400"></h2>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-6 relative overflow-hidden dark:bg-gray-700">
                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2.5 rounded-full transition-all duration-500 ease-in-out" style="width: 0%;"></div>
                <div class="flex justify-between text-xs font-medium text-gray-600 mt-2 dark:text-gray-400">
                    <span id="step1Label" class="flex-1 text-center active-step">×‘×—×™×¨×ª ××©×¤×—×”</span>
                    <span id="step2Label" class="flex-1 text-center">×¤×¨×˜×™ ×”×–×× ×”</span>
                    <span id="step3Label" class="flex-1 text-center">×‘×—×™×¨×ª ××•×¦×¨×™×</span>
                    <span id="step4Label" class="flex-1 text-center">××™×©×•×¨ ×•×©×œ×™×—×”</span>
                </div>
            </div>
        </header>

        <!-- Main content area - dynamic sections -->
        <main class="flex-grow overflow-y-auto custom-scrollbar p-2">
            <!-- Section: Login -->
            <section id="loginContent" class="content-section">
                <h3 class="text-2xl font-bold text-dark-blue mb-4 text-center dark:text-white">×‘×¨×•×›×™× ×”×‘××™×!</h3>
                <p class="text-center text-gray-700 mb-6 dark:text-gray-300">×× × ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª ×”×”×–×× ×•×ª.</p>
                <div class="form-group mb-4">
                    <label for="usernameInput" class="input-label block mb-2 text-lg font-semibold text-gray-700 dark:text-gray-300">×©× ××©×ª××©:</label>
                    <input type="text" id="usernameInput" class="glass-input" placeholder="×”×§×œ×“ ×©× ××©×ª××©">
                </div>
                <div class="form-group mb-6">
                    <label for="passwordInput" class="input-label block mb-2 text-lg font-semibold text-gray-700 dark:text-gray-300">×¡×™×¡××”:</label>
                    <input type="password" id="passwordInput" class="glass-input" placeholder="×”×§×œ×“ ×¡×™×¡××”">
                </div>
                <button id="loginBtn" class="btn-primary btn-shine w-full py-3">
                    <i class="fas fa-sign-in-alt mr-2"></i> ×”×ª×—×‘×¨
                </button>
            </section>

            <!-- Section: Step 1 - Family Selection -->
            <section id="step1Content" class="content-section hidden">
                <h3 class="text-2xl font-bold text-dark-blue mb-4 text-center dark:text-white">×©×œ×‘ 1: ×‘×—×¨ ××©×¤×—×”</h3>
                <div class="form-group mb-6">
                    <label for="familySelect" class="input-label block mb-2 text-lg font-semibold text-gray-700 dark:text-gray-300">×‘×—×¨ ××©×¤×—×” ×§×™×™××ª:</label>
                    <select id="familySelect" class="glass-input text-lg py-3">
                        <option value="">-- ×‘×—×¨ ××©×¤×—×” --</option>
                    </select>
                </div>
                <div id="quickFamilyButtons" class="flex flex-wrap justify-center gap-3 mb-6">
                    <p class="w-full text-center text-gray-600 mb-2 dark:text-gray-400">××• ×‘×—×¨ ××”×¨×©×™××” ×”××”×™×¨×”:</p>
                    <!-- Quick family buttons will be populated by JS -->
                </div>
            </section>

            <!-- Section: Order Form (Combines former Step 2, 3, 4 logic) -->
            <section id="orderFormContent" class="content-section hidden">
                <h3 id="dynamicFamilyHeading" class="text-3xl font-bold text-dark-blue mb-6 text-center dark:text-white"></h3>

                <!-- Family Details Form -->
                <div id="familyDetailsForm" class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8 border-2 border-indigo-300 dark:bg-gray-700 dark:border-indigo-500">
                    <h4 class="text-xl font-semibold text-dark-blue mb-4 dark:text-white">×¤×¨×˜×™ ××©×¤×—×” ×•×›×ª×•×‘×ª</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label for="familyNameDisplay" class="input-label block mb-2 text-gray-700 dark:text-gray-300">×©× ××©×¤×—×”:</label>
                            <input type="text" id="familyNameDisplay" class="glass-input" readonly>
                        </div>
                        <div class="form-group">
                            <label for="addressInput" class="input-label block mb-2 text-gray-700 dark:text-gray-300">×›×ª×•×‘×ª:</label>
                            <input type="text" id="addressInput" class="glass-input" placeholder="×›×ª×•×‘×ª ××œ××”">
                        </div>
                        <div class="form-group">
                            <label for="contactInput" class="input-label block mb-2 text-gray-700 dark:text-gray-300">××™×© ×§×©×¨:</label>
                            <input type="text" id="contactInput" class="glass-input" placeholder="×©× ××™×© ×§×©×¨">
                        </div>
                        <div class="form-group">
                            <label for="phoneInput" class="input-label block mb-2 text-gray-700 dark:text-gray-300">×˜×œ×¤×•×Ÿ:</label>
                            <input type="tel" id="phoneInput" class="glass-input" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ">
                        </div>
                        <div class="form-group">
                            <label for="deliveryType" class="input-label block mb-2 text-gray-700 dark:text-gray-300">×¡×•×’ ×”×•×‘×œ×”:</label>
                            <select id="deliveryType" class="glass-input">
                                <option value="">-- ×‘×—×¨ ×¡×•×’ ×”×•×‘×œ×” --</option>
                                <option value="×¨×’×™×œ×”">×¨×’×™×œ×”</option>
                                <option value="×× ×•×£">×× ×•×£</option>
                                <option value="×”×•×‘×œ×” ×§×˜× ×”">×”×•×‘×œ×” ×§×˜× ×”</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Previous Orders History -->
                <div class="bg-blue-50 p-6 rounded-xl shadow-inner mb-8 border-2 border-blue-400 dark:bg-gray-700 dark:border-blue-600">
                    <h4 class="text-xl font-semibold text-dark-blue mb-4 flex items-center dark:text-white">
                        <i class="fas fa-history mr-2 text-blue-600 dark:text-blue-400"></i> ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×§×•×“××•×ª ×œ××©×¤×—×”
                    </h4>
                    <div id="historyDisplay" class="max-h-60 overflow-y-auto custom-scrollbar p-2">
                        <p class="text-gray-500 dark:text-gray-400">×‘×—×¨ ××©×¤×—×” ×›×“×™ ×œ×¨××•×ª ×”×™×¡×˜×•×¨×™×”.</p>
                    </div>
                </div>

                <!-- Product Selection -->
                <div class="bg-green-50 p-6 rounded-xl shadow-inner mb-8 border-2 border-green-400 dark:bg-gray-700 dark:border-green-600">
                    <h4 class="text-xl font-semibold text-dark-blue mb-4 flex items-center dark:text-white">
                        <i class="fas fa-boxes mr-2 text-green-600 dark:text-green-400"></i> ×‘×—×™×¨×ª ××•×¦×¨×™× ×œ×”×–×× ×”
                    </h4>
                    <div id="productsContainer">
                        <!-- Product selection rows will be added here by JS -->
                    </div>
                    <button id="addProductBtn" class="btn-secondary btn-shine w-full mt-4 py-3">
                        <i class="fas fa-plus-circle mr-2"></i> ×”×•×¡×£ ××•×¦×¨ × ×•×¡×£
                    </button>
                </div>

                <!-- Image Upload -->
                <div class="bg-yellow-50 p-6 rounded-xl shadow-inner mb-8 border-2 border-yellow-400 dark:bg-gray-700 dark:border-yellow-600">
                    <h4 class="text-xl font-semibold text-dark-blue mb-4 flex items-center dark:text-white">
                        <i class="fas fa-camera mr-2 text-yellow-600 dark:text-yellow-400"></i> ×”×¢×œ××ª ×ª××•× ×ª ××•×¦×¨ ××”×©×˜×— (××•×¤×¦×™×•× ×œ×™)
                    </h4>
                    <input type="file" id="productImage" accept="image/*" class="glass-input w-full p-2">
                    <p class="text-sm text-gray-600 mt-2 dark:text-gray-400">× ×™×ª×Ÿ ×œ×¦×¨×£ ×ª××•× ×” ××—×ª ×©×œ ××•×¦×¨ ××”××ª×¨.</p>
                </div>

                <!-- Current Order Summary -->
                <div class="bg-purple-50 p-6 rounded-xl shadow-inner mb-8 border-2 border-purple-400 dark:bg-gray-700 dark:border-purple-600">
                    <h4 class="text-xl font-semibold text-dark-blue mb-4 flex items-center dark:text-white">
                        <i class="fas fa-shopping-cart mr-2 text-purple-600 dark:text-purple-400"></i> ×¡×™×›×•× ×”×–×× ×” × ×•×›×—×™×ª
                    </h4>
                    <input type="text" id="productFilterInput" class="glass-input mb-4" placeholder="×¡× ×Ÿ ××•×¦×¨×™× ×‘×¨×©×™××”...">
                    <div id="currentOrderProductsList" class="max-h-60 overflow-y-auto custom-scrollbar p-2">
                        <p class="text-gray-500 text-center dark:text-gray-400">××™×Ÿ ××•×¦×¨×™× ×‘×”×–×× ×” ×–×• ×¢×“×™×™×Ÿ.</p>
                    </div>
                </div>

                <button id="submitOrderBtn" class="btn-primary btn-shine w-full mt-6 py-3">
                    <i class="fas fa-paper-plane mr-2"></i> ×©×œ×— ×”×–×× ×”
                </button>
            </section>

            <!-- Section: Contacts List -->
            <section id="contactsContent" class="content-section hidden">
                <h3 class="text-2xl font-bold text-dark-blue mb-4 text-center dark:text-white">×× ×©×™ ×§×©×¨</h3>
                <input type="text" id="contactFilterInput" class="glass-input mb-4" placeholder="×¡× ×Ÿ ×× ×©×™ ×§×©×¨...">
                <div id="contactsList" class="max-h-96 overflow-y-auto custom-scrollbar p-2">
                    <p class="text-gray-500 text-center dark:text-gray-400">×˜×•×¢×Ÿ ×× ×©×™ ×§×©×¨...</p>
                </div>
            </section>

            <!-- Section: Chat Interface -->
            <section id="chatContent" class="content-section hidden flex flex-col h-full">
                <h3 id="chatContactNameHeader" class="text-2xl font-bold text-dark-blue mb-4 text-center dark:text-white">×¦'××˜ ×•×•××˜×¡××¤</h3>
                <div id="chatMessages" class="flex-grow bg-gray-50 p-4 rounded-lg border border-gray-200 overflow-y-auto custom-scrollbar mb-4 flex flex-col gap-3 dark:bg-gray-700 dark:border-gray-600">
                    <p class="text-gray-500 text-center dark:text-gray-400">×”×™×¡×˜×•×¨×™×™×ª ×”×•×“×¢×•×ª ×ª×•×¤×™×¢ ×›××Ÿ.</p>
                </div>
                <div class="chat-input-area flex gap-2">
                    <input type="text" id="chatInput" class="glass-input flex-grow" placeholder="×”×§×œ×“ ×”×•×“×¢×”...">
                    <button id="sendChatBtn" class="btn-primary btn-shine flex-shrink-0 px-4 py-2">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <!-- Basic Emoji Picker (can be expanded) -->
                <div class="flex flex-wrap gap-2 mt-2 justify-center">
                    <button class="emoji-btn p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-2xl transition-colors duration-200" data-emoji="ğŸ˜€">ğŸ˜€</button>
                    <button class="emoji-btn p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-2xl transition-colors duration-200" data-emoji="ğŸ‘">ğŸ‘</button>
                    <button class="emoji-btn p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-2xl transition-colors duration-200" data-emoji="âœ…">âœ…</button>
                    <button class="emoji-btn p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-2xl transition-colors duration-200" data-emoji="ğŸ“¦">ğŸ“¦</button>
                    <button class="emoji-btn p-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-2xl transition-colors duration-200" data-emoji="ğŸšš">ğŸšš</button>
                </div>
            </section>
        </main>

        <!-- Datalist for Product Search (Global) -->
        <datalist id="productOptions"></datalist>

        <!-- Modals -->
        <!-- Image Preview Modal -->
        <div id="imagePreviewModal" class="modal-overlay hidden">
            <div class="modal-content text-center image-preview-modal-content bg-white dark:bg-gray-800">
                <button class="modal-close-btn absolute top-4 right-4 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white text-2xl" onclick="closeImagePreviewModal()"><i class="fas fa-times"></i></button>
                <img id="previewImage" src="" alt="Product Image Preview" class="max-w-full max-h-[80vh] object-contain mx-auto rounded-lg shadow-lg">
            </div>
        </div>

        <!-- Product Details/History Modal -->
        <div id="productDetailsModal" class="modal-overlay hidden">
            <div class="modal-content max-w-lg bg-white dark:bg-gray-800">
                <button class="modal-close-btn absolute top-4 right-4 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white text-2xl" onclick="closeProductDetailsModal()"><i class="fas fa-times"></i></button>
                <h3 id="productDetailsModalTitle" class="modal-title text-dark-blue dark:text-white"></h3>
                <div class="flex flex-col items-center mb-4">
                    <img id="productDetailsImage" src="" alt="Product Image" class="w-24 h-24 object-contain rounded-lg border border-gray-200 shadow-sm mb-2 dark:border-gray-600" onerror="this.onerror=null;this.src='https://placehold.co/60x60/CCCCCC/000000?text=NoImg';">
                    <p id="productDetailsName" class="font-semibold text-lg text-dark-blue dark:text-white"></p>
                    <p id="productDetailsSku" class="text-gray-600 text-sm dark:text-gray-400"></p>
                    <p id="productDetailsQuantity" class="text-gray-700 text-base dark:text-gray-300"></p>
                    <p id="productDetailsNote" class="text-gray-700 text-base dark:text-gray-300"></p>
                </div>
                <h4 class="text-lg font-semibold text-dark-blue mb-2 border-b pb-1 dark:text-white dark:border-gray-600">×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ××•×¦×¨ ×–×”:</h4>
                <div id="productHistoryInModal" class="max-h-48 overflow-y-auto custom-scrollbar p-2">
                    <!-- History will be loaded here -->
                </div>
                <button class="btn-primary btn-shine w-full mt-4 py-3" onclick="showQuantitySelectionModal(document.getElementById('productDetailsName').innerText.replace('×©×: ', ''))">
                    <i class="fas fa-cart-plus mr-2"></i> ×”×•×¡×£ ××•×¦×¨ ×–×” ×œ×”×–×× ×”
                </button>
            </div>
        </div>

        <!-- Quantity Selection Modal (for adding from history) -->
        <div id="quantitySelectionModal" class="modal-overlay hidden">
            <div class="modal-content max-w-sm bg-white dark:bg-gray-800">
                <button class="modal-close-btn absolute top-4 right-4 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white text-2xl" onclick="closeQuantitySelectionModal()"><i class="fas fa-times"></i></button>
                <h3 id="modalProductName" class="modal-title mb-4 text-dark-blue dark:text-white"></h3>
                <div class="form-group mb-4">
                    <label for="modalQuantitySelect" class="input-label block mb-2 text-gray-700 dark:text-gray-300">×›××•×ª:</label>
                    <input type="number" id="modalQuantitySelect" class="glass-input text-center" value="1" min="1">
                </div>
                <button id="addHistoricalProductBtn" class="btn-primary btn-shine w-full py-3">
                    <i class="fas fa-check-circle mr-2"></i> ××©×¨ ×•×”×•×¡×£
                </button>
            </div>
        </div>

        <!-- Order Confirmation Modal -->
        <div id="orderConfirmationModal" class="modal-overlay hidden">
            <div class="modal-content max-w-xl bg-white dark:bg-gray-800">
                <button class="modal-close-btn absolute top-4 right-4 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white text-2xl" onclick="closeConfirmationModal()"><i class="fas fa-times"></i></button>
                <h3 class="modal-title mb-4 text-dark-blue dark:text-white">××™×©×•×¨ ×”×–×× ×”</h3>
                <div id="receiptContent" class="receipt-content bg-gray-50 p-4 rounded-lg border border-gray-200 max-h-[70vh] overflow-y-auto custom-scrollbar dark:bg-gray-700 dark:border-gray-600">
                    <!-- Receipt summary will be generated here by JS -->
                </div>
                <!-- New WhatsApp Share Button -->
                <button id="whatsappShareBtn" class="btn-primary btn-shine w-full mt-6 py-3">
                    <i class="fab fa-whatsapp mr-2"></i> ×©×œ×— ×œ×•×•××˜×¡××¤
                </button>
            </div>
        </div>

        <!-- Interactive Pop-up for "Product was purchased before..." -->
        <div id="productExistsConfirmationModal" class="modal-overlay hidden">
            <div class="modal-content max-w-sm text-center bg-white dark:bg-gray-800">
                <h3 class="modal-title mb-4 text-dark-blue dark:text-white">×”××•×¦×¨ ×§×™×™× ×‘×”×–×× ×”!</h3>
                <p id="productExistsMessage" class="mb-6 text-lg text-gray-700 dark:text-gray-300"></p>
                <div class="flex justify-around gap-4">
                    <button id="confirmAddProductBtn" class="btn-primary btn-shine flex-1 py-3">×›×Ÿ, ×”×•×¡×£</button>
                    <button id="cancelAddProductBtn" class="btn-secondary btn-shine flex-1 py-3">×œ×, ×ª×•×“×”</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav-bar bg-white rounded-t-3xl shadow-2xl p-4 w-full max-w-4xl border-t border-blue-200 flex justify-around items-center mt-4 dark:bg-gray-800 dark:border-gray-600">
        <button id="navLoginBtn" class="nav-button active p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200" data-target-view="login">
            <i class="fas fa-door-open text-2xl mb-1"></i>
            <span class="text-sm">×›× ×™×¡×” ğŸšª</span>
        </button>
        <button id="navFamiliesBtn" class="nav-button p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200" data-target-view="families">
            <i class="fas fa-users text-2xl mb-1"></i>
            <span class="text-sm">××©×¤×—×•×ª ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
        </button>
        <button id="navContactsBtn" class="nav-button p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200" data-target-view="contacts">
            <i class="fas fa-address-book text-2xl mb-1"></i>
            <span class="text-sm">×× ×©×™ ×§×©×¨ â˜ï¸</span>
        </button>
        <button id="navChatBtn" class="nav-button p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200" data-target-view="chat">
            <i class="fas fa-comments text-2xl mb-1"></i>
            <span class="text-sm">×”×•×“×¢×•×ª ğŸ’¬</span>
        </button>
    </nav>

    <script>
        // Function to show SweetAlert2 messages (Toast style)
        function showToast(icon, title, text) {
            const duration = text.length > 19 ? 5000 : 3000; // 5 seconds for long text, 3 for short
            Swal.fire({
                icon: icon,
                title: title,
                text: text,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: duration,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
        }

        // Function to show loading overlay
        function showLoading(message = '×˜×•×¢×Ÿ × ×ª×•× ×™×...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.querySelector('p').innerText = message;
            loadingOverlay.classList.remove('opacity-0', 'invisible');
            loadingOverlay.classList.add('opacity-100', 'visible');
        }

        // Function to hide loading overlay
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('opacity-100', 'visible');
            loadingOverlay.classList.add('opacity-0', 'invisible');
        }

        // Global data stores
        let familiesData = {}; // Stores family details fetched from Google Sheet "×œ×§×•×—×•×ª"
        let productsCatalog = []; // Stores product catalog fetched from Google Sheet "××—×¡×Ÿ ××•×¦×¨×™×"
        let previousOrdersHistory = []; // Stores previous orders for smart history from "×”×–×× ×•×ª ×§×•×“××•×ª"
        let currentOrderProducts = []; // Stores products currently added to the order for display/editing
        let allContactsData = []; // Stores all contact data from Google Sheet for Contacts screen
        let lastOrderSummaryData = null; // Stores the last order summary data for WhatsApp sharing
        let currentChatContact = null; // Stores the name of the contact whose chat is currently open

        // Google Apps Script Web App URL
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxvBPHFmT9trPCTGGZrhcKAxik28Pzco7OAhnY0gWLFKDHzfFyHpllheCt9ac78RMH-ZA/exec'; // Updated URL based on console error
        // Company WhatsApp Number
        const COMPANY_WHATSAPP_NUMBER = '972508860896';

        // Current step in the order process (for progress bar)
        let currentStep = 0; // 0 for login, 1 for family select, 2 for order form, 3 for products, 4 for confirmation

        // Function to update live date and time in the header
        function updateDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false // 24-hour format
            };
            const formattedDateTime = now.toLocaleString('he-IL', options).replace(/\./g, '/').replace(',', '');
            document.getElementById('currentDateTime').textContent = formattedDateTime;
        }

        // Function for typing effect (runs once)
        let typingEffectPlayed = false;
        function typeWriter(text, i, fnCallback) {
            const typingElement = document.getElementById('typingEffectText');
            if (i < text.length) {
                typingElement.innerHTML = text.substring(0, i + 1) + '<span class="typing-effect"></span>';
                setTimeout(function() {
                    typeWriter(text, i + 1, fnCallback);
                }, 50); // Typing speed
            } else if (typeof fnCallback == 'function') {
                typingElement.innerHTML = text; // Remove blinking cursor
                // No loop, just call callback if provided
                if (fnCallback) fnCallback();
            }
        }

        // Function to start the typing animation (runs once)
        function startTypingAnimation() {
            if (!typingEffectPlayed) {
                const phrase = "×œ××©×¤×—×•×ª ×–×‘×•×œ×•×Ÿ ×¢×“×™×¨×Ÿ ×‘×¨×•×›×™× ×”×‘××™× ×œ××¢×¨×›×ª ×”×”×–×× ×•×ª!";
                typeWriter(phrase, 0, () => {
                    typingEffectPlayed = true;
                });
            }
        }

        // Function to update the progress bar and step labels
        function updateProgressBar(step) {
            currentStep = step;
            const progressBar = document.getElementById('progressBar');
            const stepLabels = [
                document.getElementById('step1Label'),
                document.getElementById('step2Label'),
                document.getElementById('step3Label'),
                document.getElementById('step4Label')
            ];

            let progressWidth = 0;
            switch (step) {
                case 1: progressWidth = 25; break;
                case 2: progressWidth = 50; break;
                case 3: progressWidth = 75; break;
                case 4: progressWidth = 100; break;
                default: progressWidth = 0; // For login/other screens
            }
            progressBar.style.width = `${progressWidth}%`;

            stepLabels.forEach((label, index) => {
                if (index + 1 <= step) {
                    label.classList.add('active-step');
                } else {
                    label.classList.remove('active-step');
                }
            });
        }

        // Function to switch between content sections
        function showContent(sectionId) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active navigation button
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                if (button.dataset.targetView === sectionId.replace('Content', '')) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // Reset progress bar if not on order form
            if (sectionId !== 'orderFormContent') {
                updateProgressBar(0);
            }
        }

        /**
         * Fetches data from Google Apps Script with exponential backoff.
         * @param {string} action The action parameter for the Apps Script.
         * @param {Object} params Additional parameters for the request.
         * @param {number} retries Current retry count.
         * @param {number} delay Current delay in milliseconds.
         * @returns {Promise<Object>} The JSON response from the Apps Script.
         */
        async function fetchWithBackoff(action, params = {}, retries = 0, delay = 1000) {
            const url = new URL(WEB_APP_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                url.searchParams.append(key, params[key]);
            }

            console.log(`Attempting fetch from: ${url.toString()} (Retry: ${retries})`); // Log the URL for debugging

            try {
                const response = await fetch(url.toString());
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP error! Status: ${response.status}. Response: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}. Response: ${errorText}`);
                }
                const data = await response.json();
                if (data.success === false) {
                    throw new Error(data.message || `Failed to perform action: ${action}`);
                }
                return data;
            } catch (error) {
                if (retries < 3) { // Max 3 retries
                    console.warn(`Fetch failed, retrying in ${delay / 1000}s...`, error);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(action, params, retries + 1, delay * 2); // Exponential backoff
                } else {
                    throw error; // Re-throw if max retries reached
                }
            }
        }

        // Function to fetch data from Google Apps Script
        async function fetchDataFromGoogleSheets() {
            showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™ ××©×¤×—×•×ª, ××•×¦×¨×™× ×•×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª...');
            try {
                const data = await fetchWithBackoff('getInitialData');
                console.log('Parsed data from Apps Script (getInitialData):', data);

                // Populate global data stores
                familiesData = {};
                if (Array.isArray(data.families)) {
                    data.families.forEach(family => {
                        familiesData[family['×©× ××©×¤×—×”']] = {
                            address: family['×›×ª×•×‘×ª'] || '×œ× ×™×“×•×¢',
                            contact: family['××™×© ×§×©×¨'] || '×œ× ×™×“×•×¢',
                            phone: family['×˜×œ×¤×•×Ÿ'] || '×œ× ×™×“×•×¢',
                        };
                    });
                } else {
                    console.warn("data.families is not an array:", data.families);
                    familiesData = {};
                }

                if (Array.isArray(data.products)) {
                    productsCatalog = data.products.map(p => ({
                        name: p['×©× ××•×¦×¨'],
                        sku: p['××§"×˜'],
                        imageUrl: p['×ª××•× ×” (URL)'] || 'https://placehold.co/60x60/CCCCCC/000000?text=NoImg'
                    }));
                } else {
                    console.warn("data.products is not an array:", data.products);
                    productsCatalog = [];
                }

                if (Array.isArray(data.previousOrders)) {
                    previousOrdersHistory = data.previousOrders;
                } else {
                    console.warn("data.previousOrders is not an array:", data.previousOrders);
                    previousOrdersHistory = [];
                }

                allContactsData = Object.values(familiesData).map(family => ({
                    familyName: family.name,
                    contactPerson: family.contact,
                    phoneNumber: family.phone,
                    address: family.address
                }));
                populateContactsList();

                populateFamilySelect();
                populateQuickFamilyButtons();
                populateProductDatalist();
                addProductSelection();

            } catch (error) {
                console.error('Error fetching initial data:', error);
                showToast('error', '×©×’×™××”', `××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ×”×¨××©×•× ×™×™×: ${error.message}. ×× × ×•×“× ×©×›×ª×•×‘×ª ×”-Apps Script × ×›×•× ×” ×•×¤×¨×•×¡×” ×›×¨××•×™.`);
                familiesData = {};
                productsCatalog = [];
                previousOrdersHistory = [];
                allContactsData = [];
            } finally {
                hideLoading();
            }
        }

        function populateFamilySelect() {
            const familySelect = document.getElementById('familySelect');
            while (familySelect.options.length > 1) {
                familySelect.remove(1);
            }
            for (const familyName in familiesData) {
                const option = document.createElement('option');
                option.value = familyName;
                option.textContent = familyName;
                familySelect.appendChild(option);
            }
            if (Object.keys(familiesData).length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "××™×Ÿ ××©×¤×—×•×ª ×–××™× ×•×ª";
                option.disabled = true;
                option.selected = true;
                familySelect.appendChild(option);
                familySelect.disabled = true;
            } else {
                familySelect.disabled = false;
            }
        }

        function populateQuickFamilyButtons() {
            const quickFamilyButtonsContainer = document.getElementById('quickFamilyButtons');
            const existingButtons = quickFamilyButtonsContainer.querySelectorAll('button');
            existingButtons.forEach(button => button.remove());

            const colorClasses = ['color-red', 'color-blue', 'color-yellow', 'color-purple', 'color-green', 'color-orange'];
            let index = 0;

            for (const familyName in familiesData) {
                const button = document.createElement('button');
                button.className = `quick-family-button ${colorClasses[index % colorClasses.length]} py-2 px-4 rounded-lg font-semibold text-white transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-1 active:translate-y-0 active:shadow-inner`;
                button.textContent = familyName;
                button.onclick = () => {
                    document.getElementById('familySelect').value = familyName;
                    document.getElementById('familySelect').dispatchEvent(new Event('change'));
                };
                quickFamilyButtonsContainer.appendChild(button);
                index++;
            }
        }

        function populateProductDatalist() {
            const productOptions = document.getElementById('productOptions');
            if (productOptions) {
                productOptions.innerHTML = '';
                productsCatalog.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.setAttribute('data-sku', product.sku);
                    productOptions.appendChild(option);
                });
            } else {
                console.warn("Datalist element with ID 'productOptions' not found. It might be dynamically removed or not present.");
            }
        }

        let productRowCounter = 0;

        function addProductSelection(productToPrepopulate = null) {
            const productsContainer = document.getElementById('productsContainer');
            const currentIndex = productRowCounter++;

            const newProductDiv = document.createElement('div');
            newProductDiv.className = 'form-group product-selection bg-gray-50 p-6 rounded-xl shadow-inner mb-8 border-2 border-indigo-300 dark:bg-gray-700 dark:border-indigo-500';
            newProductDiv.innerHTML = `
                <label for="productSearch_${currentIndex}" class="input-label block mb-2 text-gray-700 dark:text-gray-300">×©× ××•×¦×¨ / ××§"×˜:</label>
                <input type="text" id="productSearch_${currentIndex}" list="productOptions" class="glass-input product-search-input" placeholder="×”×§×œ×“ ×œ×—×™×¤×•×© ××•×¦×¨ ××• ×‘×—×¨ ××”×¨×©×™××”">

                <input type="text" id="freeTextProduct_${currentIndex}" class="glass-input free-text-product-input mt-2" placeholder="×”×§×œ×“ ×©× ××•×¦×¨ ×™×“× ×™×ª (×œ× ×—×•×‘×”)">

                <label for="quantityInput_${currentIndex}" class="input-label block mb-2 mt-2 text-gray-700 dark:text-gray-300">×›××•×ª:</label>
                <input type="number" id="quantityInput_${currentIndex}" class="glass-input quantity-input" value="1" min="1">
                <input type="text" id="productNote_${currentIndex}" class="glass-input product-note-input mt-2" placeholder="×”×¢×¨×” ×œ××™×© ×§×©×¨ ×œ××•×¦×¨ (×œ× ×—×•×‘×”)">
                <div class="product-info-display mt-2 p-3 bg-blue-100 rounded-lg border-l-4 border-blue-500 flex items-center gap-4 shadow-sm dark:bg-blue-800 dark:border-blue-400 dark:text-gray-200" id="productInfo_${currentIndex}"></div>
                <div class="product-history-info mt-2 p-3 bg-yellow-100 rounded-lg border-l-4 border-yellow-500 shadow-sm dark:bg-yellow-800 dark:border-yellow-400 dark:text-gray-200" id="productHistoryInfo_${currentIndex}"></div>
                <button type="button" class="delete-product-row-btn btn-secondary btn-shine mt-4 w-full py-3" data-index="${currentIndex}">
                    <i class="fas fa-times-circle mr-2"></i> ×”×¡×¨ ××•×¦×¨ ×–×”
                </button>
            `;
            productsContainer.appendChild(newProductDiv);

            const productSearchInput = document.getElementById(`productSearch_${currentIndex}`);
            const freeTextProductInput = document.getElementById(`freeTextProduct_${currentIndex}`);
            const quantityInput = document.getElementById(`quantityInput_${currentIndex}`);
            const productNoteInput = document.getElementById(`productNote_${currentIndex}`);
            const productInfoDiv = document.getElementById(`productInfo_${currentIndex}`);
            const productHistoryInfoDiv = document.getElementById(`productHistoryInfo_${currentIndex}`);
            const deleteRowBtn = document.querySelector(`.delete-product-row-btn[data-index="${currentIndex}"]`);

            if (productToPrepopulate) {
                if (productsCatalog.some(p => p.name === productToPrepopulate.name)) {
                    productSearchInput.value = productToPrepopulate.name;
                } else {
                    freeTextProductInput.value = productToPrepopulate.name;
                }
                quantityInput.value = productToPrepopulate.quantity || 1;
                productNoteInput.value = productToPrepopulate.note || '';
                addOrUpdateCurrentOrderProduct({
                    name: productToPrepopulate.name,
                    sku: productToPrepopulate.sku || 'N/A',
                    imageUrl: productToPrepopulate.imageUrl || 'https://placehold.co/60x60/CCCCCC/000000?text=NoImg',
                    quantity: parseInt(quantityInput.value, 10),
                    note: productNoteInput.value.trim()
                }, currentIndex);
                updateProductDisplayAndData(productSearchInput, freeTextProductInput, quantityInput, productNoteInput, productInfoDiv, productHistoryInfoDiv, currentIndex);
            }

            productSearchInput.addEventListener('input', (event) => {
                updateProductDisplayAndData(productSearchInput, freeTextProductInput, quantityInput, productNoteInput, productInfoDiv, productHistoryInfoDiv, currentIndex);
            });

            freeTextProductInput.addEventListener('input', (event) => {
                updateProductDisplayAndData(productSearchInput, freeTextProductInput, quantityInput, productNoteInput, productInfoDiv, productHistoryInfoDiv, currentIndex);
            });

            quantityInput.addEventListener('input', () => {
                updateProductDisplayAndData(productSearchInput, freeTextProductInput, quantityInput, productNoteInput, productInfoDiv, productHistoryInfoDiv, currentIndex);
            });

            productNoteInput.addEventListener('input', () => {
                updateProductDisplayAndData(productSearchInput, freeTextProductInput, quantityInput, productNoteInput, productInfoDiv, productHistoryInfoDiv, currentIndex);
            });

            if (deleteRowBtn) {
                deleteRowBtn.addEventListener('click', () => {
                    newProductDiv.remove();
                    removeCurrentOrderProduct(currentIndex);
                    showToast('info', '×”××•×¦×¨ ×”×•×¡×¨', '×©×•×¨×ª ×”××•×¦×¨ ×”×•×¡×¨×” ××”×˜×•×¤×¡.');
                });
            }
        }

        function updateProductDisplayAndData(productSearchInput, freeTextProductInput, quantityInput, productNoteInput, productInfoDiv, productHistoryInfoDiv, currentIndex) {
            const searchInputValue = productSearchInput.value.trim();
            const freeTextInputValue = freeTextProductInput.value.trim();
            
            productInfoDiv.innerHTML = '';
            productHistoryInfoDiv.innerHTML = '';

            let productName = '';
            let productSku = 'N/A';
            let productImageUrl = 'https://placehold.co/60x60/CCCCCC/000000?text=NoImg';

            let selectedProduct = null;
            if (searchInputValue !== '') {
                selectedProduct = productsCatalog.find(p => p.name === searchInputValue);
                if (selectedProduct) {
                    productName = selectedProduct.name;
                    productSku = selectedProduct.sku;
                    productImageUrl = selectedProduct.imageUrl;
                    freeTextProductInput.value = '';
                } else {
                    productName = searchInputValue;
                }
            } else if (freeTextInputValue !== '') {
                productName = freeTextInputValue;
            }

            if (productName.length >= 3 || selectedProduct) {
                if (selectedProduct) {
                    productInfoDiv.innerHTML = `
                        <div class="product-item-display flex items-center gap-4">
                            <img src="${productImageUrl}" alt="${productName}" class="w-16 h-16 object-contain rounded-lg border border-gray-300 dark:border-gray-600" onerror="this.onerror=null;this.src='https://placehold.co/70x70/CCCCCC/000000?text=NoImg';" onclick="showImagePreviewModal('${productImageUrl}')">
                            <div class="product-details-display flex-grow">
                                <p class="product-name-display font-bold text-lg text-gray-800 dark:text-white">${productName}</p>
                                <p class="product-sku-display text-gray-600 text-sm dark:text-gray-400">××§"×˜: ${productSku}</p>
                            </div>
                        </div>
                    `;
                    updateProductHistoryDisplay(productName, productHistoryInfoDiv);
                    quantityInput.focus();
                } else if (productName.length >= 3) {
                    productInfoDiv.innerHTML = `
                        <div class="product-item-display flex items-center gap-4">
                            <img src="${productImageUrl}" alt="${productName}" class="w-16 h-16 object-contain rounded-lg border border-gray-300 dark:border-gray-600" onerror="this.onerror=null;this.src='https://placehold.co/70x70/CCCCCC/000000?text=NoImg';">
                            <div class="product-details-display flex-grow">
                                <p class="product-name-display font-bold text-lg text-gray-800 dark:text-white">${productName} (×¤×¨×™×˜ ×—×•×¤×©×™)</p>
                                <p class="product-sku-display text-gray-600 text-sm dark:text-gray-400">××§"×˜: N/A</p>
                            </div>
                        </div>
                    `;
                    productHistoryInfoDiv.innerHTML = `<p class="text-gray-500 dark:text-gray-400">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ×¤×¨×™×˜ ×—×•×¤×©×™.</p>`;
                    quantityInput.focus();
                }
            } else if (productName.length > 0 && productName.length < 3) {
                productInfoDiv.innerHTML = `<p class="text-gray-500 dark:text-gray-400">×”×§×œ×“ ×œ×¤×—×•×ª 3 ××•×ª×™×•×ª ×œ×—×™×¤×•×© ××•×¦×¨.</p>`;
            }

            addOrUpdateCurrentOrderProduct({
                name: productName,
                sku: productSku,
                imageUrl: productImageUrl,
                quantity: parseInt(quantityInput.value, 10) || 1,
                note: productNoteInput.value.trim()
            }, currentIndex);
        }

        function updateFamilyHistoryDisplay(familyName) {
            const historyDisplay = document.getElementById('historyDisplay');
            historyDisplay.innerHTML = '';

            if (!familyName.trim()) {
                historyDisplay.innerHTML = '<p class="text-gray-500 dark:text-gray-400">×‘×—×¨ ××©×¤×—×” ×›×“×™ ×œ×¨××•×ª ×”×™×¡×˜×•×¨×™×”.</p>';
                return;
            }
            
            if (!previousOrdersHistory) {
                console.error("previousOrdersHistory is undefined. Cannot update family history display.");
                historyDisplay.innerHTML = '<p class="text-red-500 dark:text-red-400">×©×’×™××”: ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ× × ×˜×¢× ×”. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£.</p>';
                return;
            }

            const familyHistory = previousOrdersHistory.filter(order =>
                order['×©× ××©×¤×—×”'] && order['×©× ××©×¤×—×”'].toLowerCase() === familyName.toLowerCase()
            );

            if (familyHistory.length > 0) {
                const aggregatedHistory = {};
                familyHistory.forEach(order => {
                    const productName = order['×©× ××•×¦×¨'];
                    const quantity = parseInt(order['×›××•×ª']) || 0;
                    const orderDate = order['×ª××¨×™×š ×•×©×¢×”'];

                    if (!aggregatedHistory[productName]) {
                        aggregatedHistory[productName] = { totalQty: 0, lastDate: '' };
                    }
                    aggregatedHistory[productName].totalQty += quantity;
                    if (orderDate > aggregatedHistory[productName].lastDate) {
                        aggregatedHistory[productName].lastDate = orderDate;
                    }
                });

                for (const prodName in aggregatedHistory) {
                    const item = aggregatedHistory[prodName];
                    const p = document.createElement('p');
                    p.className = 'history-item text-gray-700 dark:text-gray-300 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-200';
                    p.innerHTML = `<i class="fas fa-box ml-2 text-blue-500"></i> ${prodName} (×¡×”"×›: ${item.totalQty}, ××—×¨×•× ×”: ${item.lastDate.split(',')[0]})`;
                    p.addEventListener('click', () => {
                        const productFromCatalog = productsCatalog.find(p => p.name === prodName);
                        showProductDetailsModal({
                            name: prodName,
                            sku: productFromCatalog ? productFromCatalog.sku : 'N/A',
                            imageUrl: productFromCatalog ? productFromCatalog.imageUrl : 'https://placehold.co/60x60/CCCCCC/000000?text=NoImg',
                            quantity: item.totalQty,
                            note: ''
                        });
                    });
                    historyDisplay.appendChild(p);
                }
            } else {
                historyDisplay.innerHTML = '<p class="text-gray-500 dark:text-gray-400">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×–××™× ×” ×œ××©×¤×—×” ×–×•.</p>';
            }
        }

        function updateProductHistoryDisplay(productName, displayDiv) {
            const selectedFamilyName = document.getElementById('familyNameDisplay').value;
            if (!selectedFamilyName.trim()) {
                displayDiv.innerHTML = '';
                return;
            }
            
            if (!previousOrdersHistory) {
                console.error("previousOrdersHistory is undefined. Cannot update product history display.");
                displayDiv.innerHTML = '<p class="text-red-500 dark:text-red-400">×©×’×™××”: ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ× × ×˜×¢× ×”.</p>';
                return;
            }

            const familyProductOrders = previousOrdersHistory.filter(order =>
                order['×©× ××©×¤×—×”'] && order['×©× ××©×¤×—×”'].toLowerCase() === selectedFamilyName.toLowerCase() && order['×©× ××•×¦×¨'] === productName
            ).sort((a, b) => {
                    const parseDateString = (dateStr) => {
                        const [datePart, timePart] = dateStr.split(', ');
                        const [day, month, year] = datePart.split('.').map(Number);
                        const [hours, minutes, seconds] = timePart.split(':').map(Number);
                        return new Date(year, month - 1, day, hours, minutes, seconds);
                    };
                    const dateA = parseDateString(a['×ª××¨×™×š ×•×©×¢×”']);
                    const dateB = parseDateString(b['×ª××¨×™×š ×•×©×¢×”']);
                    return dateB.getTime() - dateA.getTime();
                });

            if (familyProductOrders.length > 0) {
                const totalQuantity = familyProductOrders.reduce((sum, order) => sum + (parseInt(order['×›××•×ª']) || 0), 0);
                
                const lastOrderDate = familyProductOrders[0]['×ª××¨×™×š ×•×©×¢×”'].split(',')[0];

                displayDiv.innerHTML = `
                    <i class="fas fa-history ml-2 text-yellow-600 dark:text-yellow-400"></i> ×”××•×¦×¨ '${productName}' ×”×•×–××Ÿ ${totalQuantity} ×¤×¢××™× (××—×¨×•× ×”: ${lastOrderDate})
                `;
            } else {
                displayDiv.innerHTML = `<i class="fas fa-info-circle ml-2 text-gray-500 dark:text-gray-400"></i> ×”××•×¦×¨ '${productName}' ×œ× ×”×•×–××Ÿ ×‘×¢×‘×¨ ×¢×œ ×™×“×™ ××©×¤×—×” ×–×•.`;
            }
        }

        let selectedHistoricalProductName = '';

        function showQuantitySelectionModal(productName) {
            selectedHistoricalProductName = productName;
            document.getElementById('modalProductName').innerText = `×”×•×¡×£: ${productName}`;
            document.getElementById('modalQuantitySelect').value = '1';
            document.getElementById('quantitySelectionModal').classList.remove('hidden');
            document.getElementById('quantitySelectionModal').classList.add('active');
        }

        function closeQuantitySelectionModal() {
            document.getElementById('quantitySelectionModal').classList.remove('active');
            document.getElementById('quantitySelectionModal').classList.add('hidden');
            selectedHistoricalProductName = '';
        }

        function addHistoricalProductToOrderForm() {
            const quantity = parseInt(document.getElementById('modalQuantitySelect').value, 10);
            if (selectedHistoricalProductName && quantity > 0) {
                const product = productsCatalog.find(p => p.name === selectedHistoricalProductName);
                const sku = product ? product.sku : 'N/A';
                const imageUrl = product ? product.imageUrl : 'https://placehold.co/60x60/CCCCCC/000000?text=NoImg';

                const isProductAlreadyInOrder = currentOrderProducts.some(p => p.name === selectedHistoricalProductName);

                if (isProductAlreadyInOrder) {
                    document.getElementById('productExistsMessage').innerText = `×”××•×¦×¨ '${selectedHistoricalProductName}' ×›×‘×¨ ×§×™×™× ×‘×”×–×× ×”. ×”×× ×ª×¨×¦×” ×œ×”×•×¡×™×£ ××•×ª×• ×©×•×‘?`;
                    document.getElementById('productExistsConfirmationModal').classList.remove('hidden');
                    document.getElementById('productExistsConfirmationModal').classList.add('active');

                    document.getElementById('productExistsConfirmationModal').dataset.tempProductData = JSON.stringify({
                        name: selectedHistoricalProductName,
                        sku: sku,
                        imageUrl: imageUrl,
                        quantity: quantity,
                        note: ''
                    });
                    document.getElementById('productExistsConfirmationModal').dataset.fromHistory = 'true';

                    closeQuantitySelectionModal();
                    return;
                }

                addProductSelection({
                    name: selectedHistoricalProductName,
                    sku: sku,
                    imageUrl: imageUrl,
                    quantity: quantity,
                    note: ''
                });

                showToast('success', '× ×•×¡×£ ×‘×”×¦×œ×—×”', `'${selectedHistoricalProductName}' ×‘×›××•×ª ${quantity} × ×•×¡×£ ×œ×”×–×× ×”.`);
                closeQuantitySelectionModal();
                closeProductDetailsModal();
            } else {
                showToast('error', '×©×’×™××”', '×× × ×‘×—×¨ ×›××•×ª ×—×•×§×™×ª.');
            }
        }

        function addOrUpdateCurrentOrderProduct(productData, formIndex) {
            if (formIndex === undefined) {
                console.warn("addOrUpdateCurrentOrderProduct called without formIndex. This should ideally come from addHistoricalProductToOrderForm or addProductSelection.");
                return;
            }

            const existingIndex = currentOrderProducts.findIndex(p => p.formIndex === formIndex);

            if (!productData.name.trim() || productData.quantity <= 0) {
                if (existingIndex > -1) {
                    currentOrderProducts.splice(existingIndex, 1);
                }
            } else {
                const isProductAlreadyInOrder = currentOrderProducts.some(p =>
                    p.name === productData.name && p.formIndex !== formIndex
                );

                if (isProductAlreadyInOrder) {
                    document.getElementById('productExistsMessage').innerText = `×”××•×¦×¨ '${productData.name}' ×›×‘×¨ ×§×™×™× ×‘×”×–×× ×”. ×”×× ×ª×¨×¦×” ×œ×”×•×¡×™×£ ××•×ª×• ×©×•×‘?`;
                    document.getElementById('productExistsConfirmationModal').classList.remove('hidden');
                    document.getElementById('productExistsConfirmationModal').classList.add('active');

                    document.getElementById('productExistsConfirmationModal').dataset.tempProductData = JSON.stringify(productData);
                    document.getElementById('productExistsConfirmationModal').dataset.tempFormIndex = formIndex;
                    document.getElementById('productExistsConfirmationModal').dataset.fromHistory = 'false';

                    if (existingIndex > -1) {
                        currentOrderProducts.splice(existingIndex, 1);
                    }
                    renderCurrentOrderProducts();
                    return;
                }

                if (existingIndex > -1) {
                    currentOrderProducts[existingIndex] = { ...productData, formIndex };
                } else {
                    currentOrderProducts.push({ ...productData, formIndex });
                }
            }
            renderCurrentOrderProducts();
        }

        function handleProductExistsConfirmation(confirm) {
            const modal = document.getElementById('productExistsConfirmationModal');
            modal.classList.remove('active');
            modal.classList.add('hidden');

            const productData = JSON.parse(modal.dataset.tempProductData);
            const formIndex = parseInt(modal.dataset.tempFormIndex, 10);
            const fromHistory = modal.dataset.fromHistory === 'true';

            if (confirm) {
                const existingIndex = currentOrderProducts.findIndex(p => p.formIndex === formIndex);
                if (existingIndex > -1) {
                    currentOrderProducts[existingIndex] = { ...productData, formIndex };
                } else {
                    currentOrderProducts.push({ ...productData, formIndex });
                }
                showToast('info', '×”××•×¦×¨ × ×•×¡×£', `'${productData.name}' × ×•×¡×£ ×©×•×‘ ×œ×”×–×× ×”.`);
            } else {
                const productDivToRemove = document.querySelector(`.product-selection input[id="productSearch_${formIndex}"]`)?.closest('.product-selection') ||
                                        document.querySelector(`.product-selection input[id="freeTextProduct_${formIndex}"]`)?.closest('.product-selection');
                if (productDivToRemove) {
                    productDivToRemove.remove();
                }
                if (fromHistory) {
                    selectedHistoricalProductName = '';
                }
                showToast('info', '×”×¤×¢×•×œ×” ×‘×•×˜×œ×”', `'${productData.name}' ×œ× × ×•×¡×£ ×©×•×‘ ×œ×”×–×× ×”.`);
            }
            renderCurrentOrderProducts();
        }

        function removeCurrentOrderProduct(formIndex) {
            currentOrderProducts = currentOrderProducts.filter(p => p.formIndex !== formIndex);
            renderCurrentOrderProducts();
            showToast('info', '×”××•×¦×¨ ×”×•×¡×¨', '×©×•×¨×ª ×”××•×¦×¨ ×”×•×¡×¨×” ××¨×©×™××ª ×”×”×–×× ×”.');
        }

        function renderCurrentOrderProducts() {
            const listContainer = document.getElementById('currentOrderProductsList');
            const filterInput = document.getElementById('productFilterInput');
            const filterText = filterInput.value.trim().toLowerCase();

            listContainer.innerHTML = '';

            if (currentOrderProducts.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center dark:text-gray-400">××™×Ÿ ××•×¦×¨×™× ×‘×”×–×× ×” ×–×• ×¢×“×™×™×Ÿ.</p>';
                return;
            }

            const filteredProducts = currentOrderProducts.filter(p =>
                p.name.toLowerCase().includes(filterText) || (p.sku && p.sku.toLowerCase().includes(filterText))
            );

            if (filteredProducts.length === 0 && filterText !== '') {
                listContainer.innerHTML = '<p class="text-gray-500 text-center dark:text-gray-400">×œ× × ××¦××• ××•×¦×¨×™× ×ª×•×××™× ×œ×—×™×¤×•×©.</p>';
                return;
            }

            filteredProducts.sort((a, b) => a.name.localeCompare(b.name, 'he'));

            filteredProducts.forEach(product => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'current-order-product-item bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-2 flex justify-between items-center dark:bg-gray-700 dark:border-gray-600';
                itemDiv.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="product-image-thumb w-12 h-12 object-contain rounded-md border border-gray-300 dark:border-gray-600 cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/40x40/CCCCCC/000000?text=NoImg';" onclick="showImagePreviewModal('${product.imageUrl}')">
                    <div class="product-details-summary flex-grow flex flex-col mr-2">
                        <strong class="text-gray-800 dark:text-white">${product.name}</strong>
                        <span class="text-gray-600 text-sm dark:text-gray-400">××§"×˜: ${product.sku}</span>
                        <input type="text" class="product-note-input-inline glass-input text-sm mt-1" value="${product.note || ''}" placeholder="×”×¢×¨×”" data-form-index="${product.formIndex}">
                    </div>
                    <div class="product-quantity-controls flex items-center gap-2">
                        <label for="qty_item_${product.formIndex}" class="sr-only">×›××•×ª</label>
                        <input type="number" id="qty_item_${product.formIndex}" class="quantity-input-small glass-input w-20 text-center" value="${product.quantity}" min="1">
                    </div>
                    <div class="action-buttons ml-2">
                        <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition-colors duration-200 btn-shine" data-form-index="${product.formIndex}"><i class="fas fa-trash"></i> ××—×§</button>
                    </div>
                `;
                listContainer.appendChild(itemDiv);

                const qtyInput = itemDiv.querySelector(`#qty_item_${product.formIndex}`);
                if (qtyInput) {
                    qtyInput.addEventListener('input', (event) => {
                        const newQuantity = parseInt(event.target.value, 10);
                        const productToUpdate = currentOrderProducts.find(p => p.formIndex === product.formIndex);
                        if (productToUpdate) {
                            if (newQuantity > 0) {
                                productToUpdate.quantity = newQuantity;
                            } else { 
                                removeCurrentOrderProduct(product.formIndex);
                            }
                        }
                    });
                    qtyInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const nextProductRow = itemDiv.nextElementSibling;
                            if (nextProductRow) {
                                const nextProductSearchInput = nextProductRow.querySelector('.product-search-input');
                                if (nextProductSearchInput) {
                                    nextProductSearchInput.focus();
                                }
                            } else {
                                addProductBtn.click();
                                const newProductSearchInput = productsContainer.lastElementChild.querySelector('.product-search-input');
                                if (newProductSearchInput) {
                                    newProductSearchInput.focus();
                                }
                            }
                        }
                    });
                }

                const inlineNoteInput = itemDiv.querySelector('.product-note-input-inline');
                if (inlineNoteInput) {
                    inlineNoteInput.addEventListener('input', (event) => {
                        const updatedNote = event.target.value.trim();
                        const productToUpdate = currentOrderProducts.find(p => p.formIndex === product.formIndex);
                        if (productToUpdate) {
                            productToUpdate.note = updatedNote;
                        }
                    });
                }

                const deleteButton = itemDiv.querySelector('.delete-btn');
                if (deleteButton) {
                    deleteButton.addEventListener('click', () => {
                        removeCurrentOrderProduct(product.formIndex);
                    });
                }
            });
        }

        let imagePreviewTimeout;
        function showImagePreviewModal(imageUrl) {
            const modal = document.getElementById('imagePreviewModal');
            const previewImage = document.getElementById('previewImage');

            previewImage.src = imageUrl;
            previewImage.classList.remove('fade-out');

            modal.classList.remove('hidden');
            modal.classList.add('active');

            if (imagePreviewTimeout) {
                clearTimeout(imagePreviewTimeout);
            }

            imagePreviewTimeout = setTimeout(() => {
                previewImage.classList.add('fade-out');
                previewImage.addEventListener('animationend', () => {
                    closeImagePreviewModal();
                    previewImage.classList.remove('fade-out');
                }, { once: true });
            }, 5000);
        }

        function closeImagePreviewModal() {
            clearTimeout(imagePreviewTimeout);
            document.getElementById('imagePreviewModal').classList.remove('active');
            document.getElementById('imagePreviewModal').classList.add('hidden');
            document.getElementById('previewImage').src = '';
        }

        function showProductDetailsModal(product) {
            const modal = document.getElementById('productDetailsModal');
            document.getElementById('productDetailsModalTitle').innerText = `×¤×¨×˜×™ ××•×¦×¨: ${product.name}`;
            document.getElementById('productDetailsImage').src = product.imageUrl;
            document.getElementById('productDetailsName').innerText = `×©×: ${product.name}`;
            document.getElementById('productDetailsSku').innerText = `××§"×˜: ${product.sku}`;
            document.getElementById('productDetailsQuantity').innerText = `×›××•×ª ×‘×”×–×× ×” ×–×•: ${product.quantity}`;
            document.getElementById('productDetailsNote').innerText = product.note ? `×”×¢×¨×”: ${product.note}` : '××™×Ÿ ×”×¢×¨×”.';

            const historyInModal = document.getElementById('productHistoryInModal');
            historyInModal.innerHTML = '<p class="text-gray-500 dark:text-gray-400">×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×”...</p>';

            const selectedFamilyName = document.getElementById('familyNameDisplay').value;
            if (!selectedFamilyName.trim()) {
                historyInModal.innerHTML = '<p class="text-gray-500 dark:text-gray-400">×‘×—×¨ ××©×¤×—×” ×›×“×™ ×œ×¨××•×ª ×”×™×¡×˜×•×¨×™×”.</p>';
                return;
            }
            
            if (!previousOrdersHistory) {
                console.error("previousOrdersHistory is undefined. Cannot update product history in modal.");
                historyInModal.innerHTML = '<p class="text-red-500 dark:text-red-400">×©×’×™××”: ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ× × ×˜×¢× ×”.</p>';
                return;
            }

            const productSpecificHistory = previousOrdersHistory.filter(order =>
                order['×©× ××©×¤×—×”'] && order['×©× ××©×¤×—×”'].toLowerCase() === selectedFamilyName.toLowerCase() && order['×©× ××•×¦×¨'] === product.name
            ).sort((a, b) => {
                    const parseDateString = (dateStr) => {
                        const [datePart, timePart] = dateStr.split(', ');
                        const [day, month, year] = datePart.split('.').map(Number);
                        const [hours, minutes, seconds] = timePart.split(':').map(Number);
                        return new Date(year, month - 1, day, hours, minutes, seconds);
                    };
                    const dateA = parseDateString(a['×ª××¨×™×š ×•×©×¢×”']);
                    const dateB = parseDateString(b['×ª××¨×™×š ×•×©×¢×”']);
                    return dateB.getTime() - dateA.getTime();
                });

            if (productSpecificHistory.length > 0) {
                historyInModal.innerHTML = '';
                const ul = document.createElement('ul');
                ul.className = 'list-none p-0';
                productSpecificHistory.forEach(order => {
                    const li = document.createElement('li');
                    li.className = 'bg-white p-2 rounded-md mb-2 shadow-sm border border-gray-200 dark:bg-gray-700 dark:border-gray-600 text-gray-800 dark:text-gray-200';
                    li.innerHTML = `
                        <p><strong>××©×¤×—×”:</strong> ${order['×©× ××©×¤×—×”']}</p>
                        <p><strong>×ª××¨×™×š:</strong> ${order['×ª××¨×™×š ×•×©×¢×”'].split(',')[0]}</p>
                        <p><strong>×©×¢×”:</strong> ${order['×ª××¨×™×š ×•×©×¢×”'].split(',')[1]}</p>
                        <p><strong>×›××•×ª:</strong> ${order['×›××•×ª']}</p>
                    `;
                    ul.appendChild(li);
                });
                historyInModal.appendChild(ul);
            } else {
                historyInModal.innerHTML = '<p class="text-gray-500 dark:text-gray-400">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×œ××•×¦×¨ ×–×” ×¢×œ ×™×“×™ ××©×¤×—×” ×–×•.</p>';
            }

            modal.classList.remove('hidden');
            modal.classList.add('active');
        }

        function closeProductDetailsModal() {
            document.getElementById('productDetailsModal').classList.remove('active');
            document.getElementById('productDetailsModal').classList.add('hidden');
        }

        function showConfirmationModal(orderSummary) {
            const modal = document.getElementById('orderConfirmationModal');
            const receiptContent = document.getElementById('receiptContent');

            lastOrderSummaryData = orderSummary;

            let productsHtml = '<ul>';
            orderSummary.products.forEach(p => {
                productsHtml += `<li class="text-gray-800 dark:text-gray-200"><span class="product-receipt-name font-semibold">${p.name}</span> <span class="product-receipt-qty text-blue-600 dark:text-blue-400">Ã— ${p.quantity}</span></li>`;
                if (p.note) {
                    productsHtml += `<li class="text-sm text-gray-600 mr-4 dark:text-gray-400">×”×¢×¨×”: ${p.note}</li>`;
                }
            });
            productsHtml += '</ul>';

            receiptContent.innerHTML = `
                <h4 class="text-center text-2xl font-bold text-dark-blue mb-4 dark:text-white">×§×‘×œ×” / ×ª×¢×•×“×ª ××©×œ×•×—</h4>
                <p class="text-gray-700 dark:text-gray-300"><strong>××©×¤×—×”:</strong> ${orderSummary.familyName}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>×›×ª×•×‘×ª:</strong> ${orderSummary.address}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>××™×© ×§×©×¨:</strong> ${orderSummary.contact}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>×˜×œ×¤×•×Ÿ:</strong> ${orderSummary.phone}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>×¡×•×’ ×”×•×‘×œ×”:</strong> ${orderSummary.deliveryType || '×œ× × ×‘×—×¨'}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>×ª××¨×™×š:</strong> ${orderSummary.timestamp.split(',')[0]}</p>
                <p class="text-gray-700 dark:text-gray-300"><strong>×©×¢×”:</strong> ${orderSummary.timestamp.split(',')[1]}</p>
                <h5 class="text-xl font-semibold text-dark-blue mt-4 mb-2 dark:text-white">×¤×¨×˜×™ ××•×¦×¨×™×:</h5>
                ${productsHtml}
                ${orderSummary.imageData ? '<p class="mt-4 text-center text-gray-600 dark:text-gray-400"><i class="fas fa-image ml-2"></i> ×¦×•×¨×¤×” ×ª××•× ×ª ××•×¦×¨ ××”×©×˜×—</p>' : ''}
                <p class="text-center text-lg font-bold text-dark-blue mt-6 animate-pulse-effect dark:text-white">
                    ×œ××—×¨ ×‘×“×™×§×ª ×”× ×ª×•× ×™×, ×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×œ××˜×” ×œ×©×œ×™×—×” ×¡×•×¤×™×ª!
                </p>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('active');
        }

        function closeConfirmationModal() {
            document.getElementById('orderConfirmationModal').classList.remove('active');
            document.getElementById('orderConfirmationModal').classList.add('hidden');
        }

        /**
         * Sends the order data to Google Apps Script.
         * @param {Object} orderData The structured order data.
         * @returns {Promise<Object>} The JSON response from the Apps Script.
         */
        async function sendOrder(orderData) {
            showLoading('×©×•×œ×— ×”×–×× ×” ×•×©×•××¨...');
            const formData = new FormData();
            formData.append('action', 'submitOrder');
            formData.append('timestamp', orderData.timestamp);
            formData.append('familyName', orderData.familyName);
            formData.append('address', orderData.address);
            formData.append('contact', orderData.contact);
            formData.append('phone', orderData.phone);
            formData.append('deliveryType', orderData.deliveryType);
            formData.append('products', JSON.stringify(orderData.products)); 
            
            if (orderData.imageData) {
                formData.append('imageData', orderData.imageData);
                formData.append('imageFileName', orderData.imageFileName || 'image.png');
            }

            try {
                const response = await fetchWithBackoff('submitOrder', {}, 0, 1000, formData); // Pass formData as body
                return response;
            } catch (error) {
                console.error('Error sending order:', error);
                throw new Error(`××™×¨×¢×” ×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×”: ${error.message}. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.`);
            } finally {
                hideLoading();
            }
        }

        /**
         * Generates and sends WhatsApp message.
         * @param {Object} orderData The structured order data.
         */
        function sendOrderToWhatsApp(orderData) {
            let whatsappMessage = `*ğŸ“¦ ×”×–×× ×” ×—×“×©×” - ${orderData.contact} ×××©×¤×—×ª ${orderData.familyName}*\n\n`;
            whatsappMessage += `*×›×ª×•×‘×ª:* ${orderData.address}\n`;
            whatsappMessage += `*×˜×œ×¤×•×Ÿ:* ${orderData.phone}\n`;
            whatsappMessage += `*×¡×•×’ ×”×•×‘×œ×”:* ${orderData.deliveryType || '×œ× × ×‘×—×¨'}\n`;
            whatsappMessage += `\nğŸ§¾ *××•×¦×¨×™×:*\n`;
            orderData.products.forEach(p => {
                whatsappMessage += `â€¢ ${p.name} Ã— ${p.quantity}`;
                if (p.note) {
                    whatsappMessage += ` (×”×¢×¨×”: ${p.note})`;
                }
                whatsappMessage += `\n`;
            });
            whatsappMessage += `\nğŸ•“ *×ª××¨×™×š:* ${orderData.timestamp.split(',')[0]}\n`;
            whatsappMessage += `*×©×¢×”:* ${orderData.timestamp.split(',')[1]}\n`;
            if (orderData.imageData) {
                whatsappMessage += `\n*×”×¢×¨×”:* ×¦×•×¨×¤×” ×ª××•× ×” ×©×œ ××•×¦×¨ ××”×©×˜×—.`;
            }

            const whatsappUrl = `https://wa.me/${COMPANY_WHATSAPP_NUMBER}?text=${encodeURIComponent(whatsappMessage)}`;
            window.open(whatsappUrl, '_blank');
            showToast('success', '×”×•×“×¢×” × ×©×œ×—×”', '×”×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×œ×•×•×˜×¡××¤.');
        }

        /**
         * Main function to handle saving order and sharing.
         * This function orchestrates sending the order and then sharing via WhatsApp.
         */
        async function sendOrderAndShare() {
            const whatsappShareBtn = document.getElementById('whatsappShareBtn');
            whatsappShareBtn.disabled = true;
            whatsappShareBtn.classList.add('btn-loading');
            whatsappShareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×©×•×œ×—...';

            if (!lastOrderSummaryData) {
                showToast('error', '×©×’×™××”', '××™×Ÿ × ×ª×•× ×™ ×”×–×× ×” ×œ×©×™×ª×•×£. ×× × ×‘×¦×¢ ×”×–×× ×” ×ª×—×™×œ×”.');
                whatsappShareBtn.disabled = false;
                whatsappShareBtn.classList.remove('btn-loading');
                whatsappShareBtn.innerHTML = '<i class="fab fa-whatsapp mr-2"></i> ×©×œ×— ×œ×•×•××˜×¡××¤';
                return;
            }

            const productImageFile = document.getElementById('productImage').files[0];
            if (productImageFile && !lastOrderSummaryData.imageData) {
                try {
                    lastOrderSummaryData.imageData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(productImageFile);
                    });
                    lastOrderSummaryData.imageFileName = productImageFile.name;
                } catch (error) {
                    console.error('Error converting image to base64 for submission:', error);
                    showToast('error', '×©×’×™××”', '××™×¨×¢×” ×©×’×™××” ×‘×”××¨×ª ×”×ª××•× ×” ×œ×©×œ×™×—×”. × ×¡×” ×©×•×‘.');
                    whatsappShareBtn.disabled = false;
                    whatsappShareBtn.classList.remove('btn-loading');
                    whatsappShareBtn.innerHTML = '<i class="fab fa-whatsapp mr-2"></i> ×©×œ×— ×œ×•×•××˜×¡××¤';
                    return;
                }
            }

            try {
                // Modified to pass formData directly to fetch in sendOrder, not as params in fetchWithBackoff
                const result = await sendOrder(lastOrderSummaryData);

                if (result.success) {
                    showToast('success', '×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!', `×©×œ×•× ${lastOrderSummaryData.contact}, ×”×”×–×× ×” ×©×œ×š ×‘×•×¦×¢×” ×•×ª×•×¢×‘×¨ ×œ××—×œ×§×ª ×”×–×× ×•×ª. × ×™×¦×•×¨ ××™×ª×š ×§×©×¨ ×œ××•×¢×“ ××¡×¤×§×”.`);
                    sendOrderToWhatsApp(lastOrderSummaryData);
                    
                    resetOrderForm();
                    showContent('step1Content');
                    updateProgressBar(1);

                    fetchDataFromGoogleSheets();

                } else {
                    showToast('error', '×©×’×™××”', result.message || '××™×¨×¢×” ×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×”.');
                }
            }
            catch (error) {
                console.error('Error in sendOrderAndShare:', error);
                showToast('error', '×©×’×™××”', `××™×¨×¢×” ×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×”: ${error.message}. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.`);
            } finally {
                whatsappShareBtn.disabled = false;
                whatsappShareBtn.classList.remove('btn-loading');
                whatsappShareBtn.innerHTML = '<i class="fab fa-whatsapp mr-2"></i> ×©×œ×— ×œ×•×•××˜×¡××¤';
                closeConfirmationModal();
            }
        }

        function resetOrderForm() {
            document.getElementById('familySelect').value = '';
            document.getElementById('familyNameDisplay').value = '';
            document.getElementById('addressInput').value = '';
            document.getElementById('contactInput').value = '';
            document.getElementById('phoneInput').value = '';
            document.getElementById('deliveryType').value = '';
            document.getElementById('historyDisplay').innerHTML = '<p class="text-gray-500 dark:text-gray-400">×‘×—×¨ ××©×¤×—×” ×›×“×™ ×œ×¨××•×ª ×”×™×¡×˜×•×¨×™×”.</p>';
            document.getElementById('productsContainer').innerHTML = '';
            productRowCounter = 0;
            currentOrderProducts = [];
            addProductSelection();
            renderCurrentOrderProducts();
            document.getElementById('productImage').value = '';
            lastOrderSummaryData = null;
        }

        function populateContactsList() {
            const contactsListContainer = document.getElementById('contactsList');
            const contactFilterInput = document.getElementById('contactFilterInput');
            const filterText = contactFilterInput.value.trim().toLowerCase();

            contactsListContainer.innerHTML = '';

            if (allContactsData.length === 0) {
                contactsListContainer.innerHTML = '<p class="text-gray-500 text-center dark:text-gray-400">××™×Ÿ ×× ×©×™ ×§×©×¨ ×–××™× ×™×.</p>';
                return;
            }

            const filteredContacts = allContactsData.filter(contact =>
                (contact.contactPerson && contact.contactPerson.toLowerCase().includes(filterText)) ||
                (contact.familyName && contact.familyName.toLowerCase().includes(filterText)) ||
                (contact.phoneNumber && contact.phoneNumber.includes(filterText))
            );

            if (filteredContacts.length === 0 && filterText !== '') {
                contactsListContainer.innerHTML = '<p class="text-gray-500 text-center dark:text-gray-400">×œ× × ××¦××• ×× ×©×™ ×§×©×¨ ×ª×•×××™× ×œ×—×™×¤×•×©.</p>';
                return;
            }

            filteredContacts.sort((a, b) => (a.contactPerson || a.familyName).localeCompare(b.contactPerson || b.familyName, 'he'));

            filteredContacts.forEach(contact => {
                const contactDiv = document.createElement('div');
                contactDiv.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-2 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors duration-200 dark:bg-gray-700 dark:border-gray-600 dark:hover:bg-gray-600';
                contactDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-white">${contact.contactPerson || contact.familyName}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${contact.familyName ? `××©×¤×—×”: ${contact.familyName}` : ''} ${contact.phoneNumber ? `| ×˜×œ×¤×•×Ÿ: ${contact.phoneNumber}` : ''}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${contact.address ? `×›×ª×•×‘×ª: ${contact.address}` : ''}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn-secondary px-3 py-1 text-sm btn-shine" data-family-name="${contact.familyName}">
                            <i class="fas fa-eye mr-1"></i> ×”×¦×’ ×”×–×× ×•×ª
                        </button>
                        <button class="btn-primary px-3 py-1 text-sm btn-shine" data-contact-person="${contact.contactPerson || contact.familyName}">
                            <i class="fas fa-comments mr-1"></i> ×¤×ª×— ×¦'××˜
                        </button>
                    </div>
                `;
                contactsListContainer.appendChild(contactDiv);

                contactDiv.querySelector('.show-orders-btn').addEventListener('click', (event) => {
                    const familyName = event.target.dataset.familyName;
                    if (familyName) {
                        showContent('orderFormContent');
                        document.getElementById('familySelect').value = familyName;
                        document.getElementById('familyNameDisplay').value = familyName;
                        const familyDetails = familiesData[familyName];
                        if (familyDetails) {
                            document.getElementById('addressInput').value = familyDetails.address || '';
                            document.getElementById('contactInput').value = familyDetails.contact || '';
                            document.getElementById('phoneInput').value = familyDetails.phone || '';
                        }
                        updateFamilyHistoryDisplay(familyName);
                        updateProgressBar(2);
                        showToast('info', '×¤×¨×˜×™ ××©×¤×—×” × ×˜×¢× ×•', `×¤×¨×˜×™ ××©×¤×—×ª ${familyName} × ×˜×¢× ×• ×œ×˜×•×¤×¡ ×”×”×–×× ×”.`);
                    }
                });

                contactDiv.querySelector('.show-chat-btn').addEventListener('click', (event) => {
                    const contactPerson = event.target.dataset.contactPerson;
                    if (contactPerson) {
                        currentChatContact = contactPerson;
                        document.getElementById('chatContactNameHeader').innerText = `×¦'××˜ ×¢× ${contactPerson}`;
                        showContent('chatContent');
                        updateProgressBar(0);
                        fetchChatHistory(contactPerson);
                    }
                });
            });
        }

        async function fetchChatHistory(contactName) {
            showLoading(`×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¦'××˜ ×¢×‘×•×¨ ${contactName}...`);
            const chatMessagesContainer = document.getElementById('chatMessages');
            chatMessagesContainer.innerHTML = '';

            try {
                const data = await fetchWithBackoff('getChatHistory', { contactName: encodeURIComponent(contactName) });
                console.log('Chat history data:', data);

                if (data.success && Array.isArray(data.chatHistory) && data.chatHistory.length > 0) {
                    data.chatHistory.sort((a, b) => {
                        const parseDateTime = (dtStr) => {
                            const [datePart, timePart] = dtStr.split(', ');
                            const [day, month, year] = datePart.split('.').map(Number);
                            const [hours, minutes, seconds] = timePart.split(':').map(Number);
                            return new Date(year, month - 1, day, hours, minutes, seconds);
                        };
                        return parseDateTime(a['×ª××¨×™×š ×•×©×¢×”']).getTime() - parseDateTime(b['×ª××¨×™×š ×•×©×¢×”']).getTime();
                    });

                    data.chatHistory.forEach(message => {
                        if (message['×”×•×“×¢×ª ××©×ª××©']) {
                            appendChatMessage(message['×”×•×“×¢×ª ××©×ª××©'], message['×ª××¨×™×š ×•×©×¢×”'], 'user');
                        }
                        if (message['×ª×©×•×‘×ª ×× ×”×œ ××¢×¨×›×ª']) {
                            appendChatMessage(message['×ª×©×•×‘×ª ×× ×”×œ ××¢×¨×›×ª'], message['×ª××¨×™×š ×•×©×¢×”'], 'admin');
                        }
                    });
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                } else {
                    chatMessagesContainer.innerHTML = '<p class="text-gray-500 text-center dark:text-gray-400">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×¦\'××˜ ×¢×‘×•×¨ ××™×© ×§×©×¨ ×–×”.</p>';
                }
            } catch (error) {
                console.error('Error fetching chat history:', error);
                showToast('error', '×©×’×™××”', `××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×™×ª ×”×¦'××˜: ${error.message}`);
                chatMessagesContainer.innerHTML = '<p class="text-red-500 text-center dark:text-red-400">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×™×ª ×¦\'××˜.</p>';
            } finally {
                hideLoading();
            }
        }

        function appendChatMessage(messageText, timestamp, senderType) {
            const chatMessagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${senderType}-message p-3 rounded-xl max-w-[80%] relative text-gray-800 dark:text-gray-100 ${senderType === 'user' ? 'bg-blue-200 self-end rounded-br-none' : 'bg-green-200 self-start rounded-bl-none'} shadow-md`;
            messageDiv.innerHTML = `
                <p>${messageText}</p>
                <span class="message-timestamp text-xs text-gray-500 mt-1 block text-left dark:text-gray-400">${timestamp.split(',')[0]} ${timestamp.split(',')[1]}</span>
            `;
            chatMessagesContainer.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        async function sendChatMessage(message) {
            if (!message.trim()) {
                showToast('warning', '×”×•×“×¢×” ×¨×™×§×”', '×× × ×”×§×œ×“ ×”×•×“×¢×” ×œ×©×œ×™×—×”.');
                return;
            }
            if (!currentChatContact) {
                showToast('error', '×©×’×™××”', '×× × ×‘×—×¨ ××™×© ×§×©×¨ ×œ×¤× ×™ ×©×œ×™×—×ª ×”×•×“×¢×”.');
                return;
            }

            const sendChatBtn = document.getElementById('sendChatBtn');
            sendChatBtn.disabled = true;
            sendChatBtn.classList.add('btn-loading');
            sendChatBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            showLoading('×©×•×œ×— ×”×•×“×¢×” ×•×©×•××¨ ×”×™×¡×˜×•×¨×™×”...');
            const currentTimestamp = new Date().toLocaleString('he-IL', { timeZone: 'Asia/Jerusalem' });

            try {
                const formData = new FormData();
                formData.append('action', 'saveChatMessage');
                formData.append('contactName', currentChatContact);
                formData.append('timestamp', currentTimestamp);
                formData.append('userMessage', message);

                // Using fetch directly for POST requests as fetchWithBackoff is tailored for GET with params
                const response = await fetch(`${WEB_APP_URL}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    appendChatMessage(message, currentTimestamp, 'user');
                    document.getElementById('chatInput').value = '';
                    showToast('success', '×”×•×“×¢×” × ×©×œ×—×”', '×”×”×•×“×¢×” × ×©×œ×—×” ×•× ×©××¨×” ×‘×”×™×¡×˜×•×¨×™×”.');

                    const whatsappUrl = `https://wa.me/${COMPANY_WHATSAPP_NUMBER}?text=${encodeURIComponent(`×”×•×“×¢×” ×${currentChatContact}:\n${message}`)}`;
                    window.open(whatsappUrl, '_blank');

                    setTimeout(() => fetchChatHistory(currentChatContact), 1000);
                } else {
                    showToast('error', '×©×’×™××”', result.message || '××™×¨×¢×” ×©×’×™××” ×‘×©××™×¨×ª ×”×”×•×“×¢×”.');
                }
            } catch (error) {
                console.error('Error sending chat message:', error);
                showToast('error', '×©×’×™××”', `××™×¨×¢×” ×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”: ${error.message}`);
            } finally {
                hideLoading();
                sendChatBtn.disabled = false;
                sendChatBtn.classList.remove('btn-loading');
                sendChatBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const appContainer = document.querySelector('.app-container');
            const navBar = document.querySelector('.bottom-nav-bar');
            
            appContainer.classList.toggle('dark-mode');
            navBar.classList.toggle('dark-mode');

            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
            } else {
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        function applyDarkModePreference() {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.querySelector('.app-container').classList.add('dark-mode');
                document.querySelector('.bottom-nav-bar').classList.add('dark-mode');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            applyDarkModePreference();

            updateDateTime();
            setInterval(updateDateTime, 1000);

            startTypingAnimation();

            fetchDataFromGoogleSheets();

            showContent('loginContent');

            const loginBtn = document.getElementById('loginBtn');
            const familySelect = document.getElementById('familySelect');
            const dynamicFamilyHeading = document.getElementById('dynamicFamilyHeading');
            const familyNameDisplay = document.getElementById('familyNameDisplay');
            const addressInput = document.getElementById('addressInput');
            const contactInput = document.getElementById('contactInput');
            const phoneInput = document.getElementById('phoneInput');
            const historyDisplay = document.getElementById('historyDisplay');
            const addProductBtn = document.getElementById('addProductBtn');
            const submitOrderBtn = document.getElementById('submitOrderBtn');
            const deliveryTypeSelect = document.getElementById('deliveryType');
            const addHistoricalProductButton = document.getElementById('addHistoricalProductBtn');
            const productFilterInput = document.getElementById('productFilterInput');
            const confirmAddProductBtn = document.getElementById('confirmAddProductBtn');
            const cancelAddProductBtn = document.getElementById('cancelAddProductBtn');
            const contactFilterInput = document.getElementById('contactFilterInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            const chatInput = document.getElementById('chatInput');
            const emojiButtons = document.querySelectorAll('.emoji-btn');
            const whatsappShareBtn = document.getElementById('whatsappShareBtn');
            const darkModeToggle = document.getElementById('darkModeToggle');

            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', () => {
                    const targetView = button.dataset.targetView;
                    if (targetView === 'families') {
                        showContent('step1Content');
                        updateProgressBar(1);
                    } else if (targetView === 'login') {
                        showContent('loginContent');
                        updateProgressBar(0);
                    } else if (targetView === 'contacts') {
                        showContent('contactsContent');
                        populateContactsList();
                        updateProgressBar(0);
                    } else if (targetView === 'chat') {
                        showContent('chatContent');
                        updateProgressBar(0);
                        if (currentChatContact) {
                            document.getElementById('chatContactNameHeader').innerText = `×¦'××˜ ×¢× ${currentChatContact}`;
                            fetchChatHistory(currentChatContact);
                        } else {
                            document.getElementById('chatContactNameHeader').innerText = `×¦'××˜ ×•×•××˜×¡××¤`;
                            document.getElementById('chatMessages').innerHTML = '<p class="text-gray-500 text-center dark:text-gray-400">×× × ×‘×—×¨ ××™×© ×§×©×¨ ×›×“×™ ×œ×”×ª×—×™×œ ×¦\'××˜.</p>';
                        }
                    }
                });
            });

            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', toggleDarkMode);
            }

            if (loginBtn) {
                loginBtn.addEventListener('click', async () => {
                    const username = document.getElementById('usernameInput').value;
                    const password = document.getElementById('passwordInput').value;

                    loginBtn.disabled = true;
                    loginBtn.classList.add('btn-loading');
                    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××ª×—×‘×¨...';

                    await new Promise(resolve => setTimeout(resolve, 1000));

                    if (username === '×¡×‘×Ÿ' && password === '1234') {
                        showToast('success', '×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”', `×©×œ×•× ${username}, ×‘×¨×•×š ×”×‘× ×œ××¢×¨×›×ª ×”×”×–×× ×•×ª!`);
                        showContent('step1Content');
                        updateProgressBar(1);
                    } else {
                        showToast('error', '×©×’×™××ª ×”×ª×—×‘×¨×•×ª', '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×.');
                    }

                    loginBtn.disabled = false;
                    loginBtn.classList.remove('btn-loading');
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> ×”×ª×—×‘×¨';
                });
            }

            if (addHistoricalProductButton) {
                addHistoricalProductButton.addEventListener('click', addHistoricalProductToOrderForm);
            }

            if (confirmAddProductBtn) {
                confirmAddProductBtn.addEventListener('click', () => handleProductExistsConfirmation(true));
            }
            if (cancelAddProductBtn) {
                cancelAddProductBtn.addEventListener('click', () => handleProductExistsConfirmation(false));
            }

            if (productFilterInput) {
                productFilterInput.addEventListener('input', renderCurrentOrderProducts);
            }

            if (contactFilterInput) {
                contactFilterInput.addEventListener('input', populateContactsList);
            }

            if (whatsappShareBtn) {
                whatsappShareBtn.addEventListener('click', sendOrderAndShare);
            }

            familySelect.addEventListener('change', (event) => {
                const selectedFamilyName = event.target.value;
                if (selectedFamilyName && familiesData[selectedFamilyName]) {
                    showContent('orderFormContent');
                    updateProgressBar(2);

                    const data = familiesData[selectedFamilyName];
                    dynamicFamilyHeading.textContent = `×”×–×× ×” ×¢×‘×•×¨ ××©×¤×—×ª ${selectedFamilyName}`;
                    familyNameDisplay.value = selectedFamilyName;

                    addressInput.value = data.address || '';
                    addressInput.removeAttribute('readonly');
                    contactInput.value = data.contact || '';
                    contactInput.removeAttribute('readonly');
                    phoneInput.value = data.phone || '';
                    phoneInput.removeAttribute('readonly');

                    showToast('info', '×‘×¨×•×š ×”×‘×!', `×©×œ×•× ${data.contact || selectedFamilyName}, ×‘×¨×•×š ×”×‘× ×œ××¢×¨×›×ª ×”×”×–×× ×•×ª!`);

                    updateFamilyHistoryDisplay(selectedFamilyName);

                    document.getElementById('productsContainer').innerHTML = '';
                    productRowCounter = 0;
                    currentOrderProducts = [];
                    addProductSelection();
                    renderCurrentOrderProducts();

                } else {
                    resetOrderForm();
                    showContent('step1Content');
                    updateProgressBar(1);
                    if (selectedFamilyName && !familiesData[selectedFamilyName]) {
                        showToast('error', '×©×’×™××”', `×¤×¨×˜×™ ××©×¤×—×ª "${selectedFamilyName}" ×œ× × ××¦××•. ×× × ×‘×—×¨ ××©×¤×—×” ××—×¨×ª ××• ×¨×¢× ×Ÿ ××ª ×”×“×£.`);
                    }
                }
            });

            addProductBtn.addEventListener('click', () => {
                addProductSelection();
                updateProgressBar(3);
                const newProductSearchInput = document.getElementById(`productSearch_${productRowCounter - 1}`);
                if (newProductSearchInput) {
                    newProductSearchInput.focus();
                }
            });

            submitOrderBtn.addEventListener('click', async () => {
                const familyName = familyNameDisplay.value;
                const address = addressInput.value;
                const contact = contactInput.value;
                const phone = phoneInput.value;
                const deliveryType = deliveryTypeSelect.value;

                if (!familyName.trim() || !address.trim() || !contact.trim() || !phone.trim()) {
                    showToast('error', '×©×’×™××”', '×× × ××œ× ××ª ×›×œ ×¤×¨×˜×™ ×”××©×¤×—×”, ×”×›×ª×•×‘×ª, ××™×© ×”×§×©×¨ ×•×”×˜×œ×¤×•×Ÿ.');
                    return;
                }

                let hasValidProduct = currentOrderProducts.some(p => p.quantity > 0 && p.name.trim() !== '');

                if (!hasValidProduct) {
                    showToast('error', '×©×’×™××”', '×× × ×‘×—×¨ ×œ×¤×—×•×ª ××•×¦×¨ ××—×“ ×œ×”×–×× ×” ××• ×”×–×Ÿ ×©× ××•×¦×¨ ×™×“× ×™×ª.');
                    return;
                }

                if (!deliveryType) {
                    showToast('error', '×©×’×™××”', '×× × ×‘×—×¨ ×¡×•×’ ×”×•×‘×œ×”.');
                    return;
                }

                const orderSummaryData = {
                    timestamp: new Date().toLocaleString('he-IL', { timeZone: 'Asia/Jerusalem' }),
                    familyName,
                    address,
                    contact,
                    phone,
                    products: currentOrderProducts.map(p => ({
                        name: p.name,
                        sku: p.sku,
                        quantity: p.quantity,
                        note: p.note
                    })),
                    imageData: null,
                    imageFileName: null,
                    deliveryType
                };

                const productImageFile = document.getElementById('productImage').files[0];
                if (productImageFile) {
                    try {
                        orderSummaryData.imageData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.onerror = reject;
                            reader.readAsDataURL(productImageFile);
                        });
                        orderSummaryData.imageFileName = productImageFile.name;
                    } catch (error) {
                        console.error('Error converting image to base64 for display:', error);
                        showToast('error', '×©×’×™××”', '××™×¨×¢×” ×©×’×™××” ×‘×”××¨×ª ×”×ª××•× ×” ×œ×ª×¦×•×’×”. ×”×”×–×× ×” ×ª×™×©×œ×— ×œ×œ× ×ª××•× ×”.');
                        orderSummaryData.imageData = null;
                        orderSummaryData.imageFileName = null;
                    }
                }

                updateProgressBar(4);
                showConfirmationModal(orderSummaryData);
            });

            if (sendChatBtn) {
                sendChatBtn.addEventListener('click', () => {
                    sendChatMessage(chatInput.value);
                });
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage(chatInput.value);
                    }
                });
            }

            if (emojiButtons) {
                emojiButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        chatInput.value += button.dataset.emoji;
                        chatInput.focus();
                    });
                });
            }
        });
    </script>
</body>
</html>
